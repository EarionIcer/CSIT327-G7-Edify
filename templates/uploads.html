{% extends 'base.html' %}
{% load static %}

{% block title %}My Uploads - Edify{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/uploadsCss.css' %}">
{% endblock %}

{% block content %}
<div class="uploads-container">
  
  <!-- Page Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">My Uploads</h1>
      <p class="page-subtitle">Manage your shared learning materials.</p>
    </div>
    <a href="{% url 'addfiles' %}" class="btn-add">
      <i class="fa-solid fa-plus"></i> Add New File
    </a>
  </div>

  <!-- Search & Filter Toolbar -->
  <div class="card toolbar-card">
    <div class="toolbar-content">
      <div class="toolbar-left">
        <h3>Attached Files</h3>
        <span class="file-count">{{ resources|length }} Files</span>
      </div>

      <form method="get" action="{% url 'uploads' %}" class="toolbar-actions">
        <div class="search-wrapper">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" name="q" placeholder="Search files..." value="{{ query }}">
        </div>

        <div class="select-wrapper">
            <i class="fa-solid fa-filter filter-icon"></i>
            <select name="subject" onchange="this.form.submit()">
                <option value="All" {% if selected_subject == 'All' %}selected{% endif %}>All Subjects</option>
                {% for subj in subjects %}
                    <option value="{{ subj }}" {% if selected_subject == subj %}selected{% endif %}>{{ subj }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" style="display: none;"></button>
      </form>
    </div>
  </div>

  <!-- Files Table -->
  <div class="card table-card">
    <div class="table-responsive">
        <table class="custom-table">
        <thead>
            <tr>
            <th>File Name</th>
            <th>Status</th>
            <th>Subject</th>
            <th>Grade</th>
            <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody id="fileList">
            {% for file in resources %}
            <tr id="row-{{ file.id }}">
            <td>
                <div class="file-cell">
                    <div class="file-icon-box"><i class="fa-solid fa-file-lines"></i></div>
                    <div class="file-meta">
                        <span class="file-title">{{ file.title }}</span>
                        <span class="file-type">{{ file.file_type|upper }} • {{ file.file_size }}</span>
                    </div>
                </div>
            </td>
            
            <td id="status-cell-{{ file.id }}">
                {% if file.status == 'approved' %}
                    <span class="badge status-approved">Approved</span>
                {% elif file.status == 'rejected' %}
                    <span class="badge status-rejected">Rejected</span>
                {% else %}
                    <span class="badge status-pending">Pending</span>
                {% endif %}
            </td>

            <td><span class="badge subject">{{ file.subject }}</span></td>
            <td>{{ file.grade }}</td> 
            <td>
                <div class="action-buttons">
                
                <!-- 1. Visibility Toggle -->
                <form method="POST" action="{% url 'toggle_visibility' file.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button 
                        type="submit" 
                        class="icon-btn btn-visibility {% if file.visibility == 'public' %}public{% else %}private{% endif %}" 
                        title="{% if file.visibility == 'public' %}Public (Click to make Private){% else %}Private (Click to Publish){% endif %}"
                        onclick="return confirmVisibility('{{ file.visibility }}');"
                    >
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </form>

                <!-- 2. ✅ FAVORITE BUTTON (Added) -->
                <a href="{% url 'toggle_favorite' file.id %}" 
                   class="icon-btn btn-fav {% if file.is_favorite %}active{% endif %}" 
                   title="{% if file.is_favorite %}Remove from Favorites{% else %}Add to Favorites{% endif %}">
                    <!-- Logic: If favorite -> Solid Heart, Else -> Hollow Heart -->
                    <i class="{% if file.is_favorite %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i>
                </a>

                <!-- 3. Download -->
                <a href="{% url 'download_file' file.id %}" title="Download" class="icon-btn btn-download">
                    <i class="fa-solid fa-download"></i>
                </a>  

                <!-- 4. Edit -->
                <a href="{% url 'edit_file' file.id %}" title="Edit" class="icon-btn btn-edit">
                    <i class="fa-solid fa-pen"></i>
                </a>

                <!-- 5. Delete -->
                <form action="{% url 'delete_file' file.id %}" method="post" style="display:inline;" onsubmit="return confirm('Delete this file?');">
                    {% csrf_token %}
                    <button class="icon-btn btn-delete"><i class="fa-solid fa-trash"></i></button>
                </form>

                </div>
            </td>
            </tr>

            {% empty %}
            <tr>
            <td colspan="5">
                <div class="empty-state">
                    <div class="empty-icon"><i class="fa-solid fa-folder-open"></i></div>
                    <h3>No files uploaded yet.</h3>
                    <p>Click "Add New File" to get started.</p>
                </div>
            </td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
    </div>
  </div>
</div>

<script>
    function confirmVisibility(currentVisibility) {
        if (currentVisibility === 'private') {
            return confirm("Are you sure you want to make this PUBLIC?\n\nIt will be sent to the Admin for approval before appearing in the library.");
        } else {
            return confirm("Are you sure you want to make this PRIVATE?\n\nIt will be removed from the public library immediately.");
        }
    }
</script>
{% endblock %}