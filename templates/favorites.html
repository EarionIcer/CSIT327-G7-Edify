{% extends "base.html" %}
{% load static %}

{% block title %}My Favorites - Edify{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/favoritesCss.css' %}">
{% endblock %}

{% block content %}
<div class="favorites-container">
  
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">My Favorites</h1>
      <p class="page-subtitle">Your saved resources for quick access.</p>
    </div>
    <!-- Optional: Add a "Clear All" button or stats here if needed -->
  </div>

  {% if favorites %}
  <!-- Toolbar (Search & Sort) -->
  <div class="card toolbar-card">
    <div class="toolbar-content">
      
      <div class="toolbar-left">
        <span class="fav-count"><i class="fa-solid fa-heart text-red"></i> {{ favorites|length }} Items Saved</span>
      </div>

      <div class="toolbar-actions">
        <!-- Search -->
        <div class="search-wrapper">
          <i class="fa-solid fa-magnifying-glass search-icon"></i>
          <input type="text" id="searchInput" placeholder="Search by title...">
        </div>

        <!-- Sort -->
        <div class="select-wrapper">
          <i class="fa-solid fa-arrow-down-short-wide filter-icon"></i>
          <select id="sortSelect">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="az">Title (A-Z)</option>
          </select>
        </div>
      </div>

    </div>
  </div>

  <!-- Cards Grid -->
  <div class="favorites-grid" id="favoritesGrid">
    {% for file in favorites %}
    <div class="favorite-card" data-title="{{ file.title }}" data-date="{{ file.date_added|date:'Y-m-d H:i:s' }}">
      
      <!-- Card Header -->
      <div class="fav-card-header">
        <div class="icon-box">
           <!-- You can switch icons based on file type if you have logic, defaulting to file -->
           <i class="fa-solid fa-file-lines"></i>
        </div>
       {% comment %} <a href="{% url 'toggle_favorite' file.id %}" class="btn-icon-remove" title="Remove from favorites">
           <i class="fa-solid fa-heart-circle-minus"></i>
       </a> {% endcomment %}
       <button type="button"
          class="btn-icon-remove"
          onclick="toggleFavorite(this, '{{ file.id }}')"
          title="Remove from favorites">
          <i class="fa-solid fa-heart-circle-minus"></i>
      </button>
      </div>

      <!-- Card Body -->
      <div class="fav-card-body">
        <h3 class="file-title" title="{{ file.title }}">{{ file.title }}</h3>
        
        <div class="meta-tags">
            <span class="badge">{{ file.subject|default:"General" }}</span>
            <span class="text-muted">•</span>
            <span class="text-sm">{{ file.file_size }}</span>
        </div>

        <div class="file-details-list">
            <div class="detail-row">
                <span class="label">Grade:</span>
                <span class="value">{{ file.grade|default:"N/A" }}</span>
            </div>
            <div class="detail-row">
                <span class="label">Type:</span>
                <span class="value">{{ file.file_type|upper }}</span>
            </div>
            <div class="detail-row">
            <span class="label">Added to Favorites:</span>
            <span class="value">
              <span class="date-favorited" data-iso="{{ file.date_favorited_raw }}">{{ file.date_favorited }}</span>
            </span>
          </div>
        </div>
      </div>

      <!-- Card Footer -->
      <div class="fav-card-footer">
        <a href="{{ file.file_path }}" target="_blank" class="btn-view">
          <i class="fa-solid fa-eye"></i> Preview
        </a>
        <!-- Assuming you might want to download directly -->
        <a href="{% url 'download_file' file.id %}" class="btn-download" title="Download">
            <i class="fa-solid fa-download"></i>
        </a>
      </div>

    </div>
    {% endfor %}
  </div>

  {% else %}
  <!-- Empty State -->
  <div class="empty-state-card">
    <div class="empty-icon">
        <i class="fa-regular fa-heart"></i>
    </div>
    <h2>No favorites yet</h2>
    <p>Save your favorite lessons, modules, or activities to access them easily here.</p>
    <a href="{% url 'uploads' %}" class="btn-explore">Explore Files</a>
  </div>
  {% endif %}

</div>

<!-- JavaScript for Search + Sort -->
<script>
  const searchInput = document.getElementById('searchInput');
  const sortSelect = document.getElementById('sortSelect');
  const grid = document.getElementById('favoritesGrid');

  // Search filter
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const term = searchInput.value.toLowerCase();
      const cards = grid.querySelectorAll('.favorite-card');
      cards.forEach(card => {
        const title = card.dataset.title.toLowerCase();
        card.style.display = title.includes(term) ? 'flex' : 'none';
      });
    });
  }

  // Sort logic
  if (sortSelect) {
    sortSelect.addEventListener('change', () => {
      const cards = Array.from(grid.querySelectorAll('.favorite-card'));
      const sortOrder = sortSelect.value;
      
      cards.sort((a, b) => {
        const dateA = new Date(a.dataset.date);
        const dateB = new Date(b.dataset.date);
        const titleA = a.dataset.title.toLowerCase();
        const titleB = b.dataset.title.toLowerCase();

        if (sortOrder === 'newest') return dateB - dateA;
        if (sortOrder === 'oldest') return dateA - dateB;
        if (sortOrder === 'az') return titleA.localeCompare(titleB);
      });
      
      cards.forEach(card => grid.appendChild(card));
    });
  }
</script>

<script>
function getCSRF() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || "{{ csrf_token }}";
}

async function toggleFavorite(button, fileId) {
    const card = button.closest(".favorite-card");

    try {
        const res = await fetch(`/toggle_favorite/${fileId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRF(),
                "Content-Type": "application/json"
            }
        });

        const data = await res.json();

        if (data.status !== "success") {
            showToast("Failed to update favorite.", true);
            return;
        }

        // ✅ Remove instantly from page
        if (!data.is_favorite) {
            card.remove();
        }

        // ✅ Update favorites count
        const count = document.querySelector(".fav-count");
        if (count) {
            count.innerHTML = `<i class="fa-solid fa-heart text-red"></i> ${data.favorites_count} Items Saved`;
        }

        // ✅ Toast popup
        showToast(data.is_favorite ? "Added to favorites ⭐" : "Removed from favorites.");

    } catch (err) {
        console.error(err);
        showToast("Network error.", true);
    }
}
</script>


<script>
// Format all .date-favorited elements to the user's local time
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll('.date-favorited').forEach(el => {
    const iso = el.dataset.iso;
    if (!iso) return;

    try {
      // Use the browser to parse & format in local timezone
      const d = new Date(iso);
      if (isNaN(d)) {
        // Fallback: keep server-rendered text
        return;
      }

      // Options — adjust to match the style you want
      const opts = {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: 'numeric', minute: '2-digit'
      };

      // Example: "Nov 30, 2025, 6:21 PM"
      el.textContent = d.toLocaleString(undefined, opts);
    } catch (e) {
      // keep fallback text if anything fails
      console.error('Date format error', e);
    }
  });
});
</script>


{% endblock %}