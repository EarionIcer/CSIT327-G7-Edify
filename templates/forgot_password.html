{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Forgot Password</title>

  <link rel="stylesheet" href="{% static 'css/forgotPassCss.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/js/all.min.js"></script>
</head>

<body>

<div class="card">

    <!-- Back Button -->
    <a href="{% url 'login' %}" class="back-link">
        <i class="fa-solid fa-arrow-left"></i> Back to Login
    </a>

    <h2>Forgot Password</h2>
    <p class="subtitle">Recover your account in a few steps</p>

    <!-- Step 1 -->
    <div id="email-step">
        <label>Email Address</label>
        <input type="email" id="fp_email" placeholder="Enter your email" required>
        <button id="checkEmailBtn" class="btn">Next</button>
    </div>

    <!-- Step 2 -->
    <div id="password-step" style="display:none;">
        <label>New Password</label>
        <div class="password-wrapper">
            <input type="password" id="new_password" placeholder="Enter new password" required>
            <i class="fa-solid fa-eye eye-icon" onclick="togglePassword('new_password', this)"></i>
        </div>

        <label>Confirm Password</label>
        <div class="password-wrapper">
            <input type="password" id="confirm_password" placeholder="Confirm password" required>
            <i class="fa-solid fa-eye eye-icon" onclick="togglePassword('confirm_password', this)"></i>
        </div>

        <button id="savePasswordBtn" class="btn">Save Changes</button>
    </div>

    <p id="fp_message"></p>
</div>


<script>
    const checkBtn = document.getElementById("checkEmailBtn");
    const saveBtn  = document.getElementById("savePasswordBtn");

    function validatePassword(pw) {
        if (pw.length < 8) return "Password must be at least 8 characters.";
        if (!/[A-Z]/.test(pw)) return "Password must contain at least 1 uppercase letter.";
        if (!/[0-9]/.test(pw)) return "Password must contain at least 1 number.";
        if (!/[!@#$%^&*]/.test(pw)) return "Password must contain at least 1 special character.";
        return "ok";
    }

    function showMsg(msg, type) {
        const box = document.getElementById("fp_message");
        box.className = type;
        box.innerText = msg;
    }

    // STEP 1: CHECK EMAIL
    checkBtn.addEventListener("click", async () => {
        const email = document.getElementById("fp_email").value.trim();
        if (!email) return showMsg("Please enter your email.", "error");

        const formData = new FormData();
        formData.append("action", "check_email");
        formData.append("email", email);
        formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

        const response = await fetch("/reset_password/", {
            method: "POST",
            body: formData
        });

        const result = await response.json();

        if (result.status === "success") {
            showMsg("Email found! Please set your new password.", "success");
            document.getElementById("email-step").style.display = "none";
            document.getElementById("password-step").style.display = "block";
        } else {
            showMsg(result.message, "error");
        }
    });

    // STEP 2: SAVE PASSWORD
    saveBtn.addEventListener("click", async () => {
        const email = document.getElementById("fp_email").value;
        const pw1 = document.getElementById("new_password").value;
        const pw2 = document.getElementById("confirm_password").value;

        const validation = validatePassword(pw1);
        if (validation !== "ok") return showMsg(validation, "error");

        if (pw1 !== pw2) return showMsg("Passwords do not match.", "error");

        const formData = new FormData();
        formData.append("action", "reset_password");
        formData.append("email", email);
        formData.append("password", pw1);
        formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

        const response = await fetch("/reset_password/", {
            method: "POST",
            body: formData
        });

        const result = await response.json();

        if (result.status === "success") {
            showMsg("Password updated! Redirecting...", "success");

            setTimeout(() => {
                window.location.href = "/login/";
            }, 1500);
        } else {
            showMsg(result.message, "error");
        }
    });

    function togglePassword(id, icon) {
        const input = document.getElementById(id);
        if (input.type === "password") {
            input.type = "text";
            icon.classList.replace("fa-eye", "fa-eye-slash");
        } else {
            input.type = "password";
            icon.classList.replace("fa-eye-slash", "fa-eye");
        }
    }
</script>

</body>
</html>
