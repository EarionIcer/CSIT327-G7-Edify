{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edify | Forgot Password</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/forgotPassCss.css' %}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="page-wrapper">
      <div class="card">
        <!-- Back Button -->
        <a href="{% url 'login' %}" class="back-link">
          <i class="fa-solid fa-arrow-left"></i> Back to Login
        </a>

        <div class="header-section">
          <div class="icon-circle">
            <i class="fas fa-lock"></i>
          </div>
          <h2>Forgot Password?</h2>
          <p class="subtitle">
            {% if step == 1 %} No worries! Enter your email and we'll help you
            reset it. {% else %} Create a new strong password for your account.
            {% endif %}
          </p>
        </div>

        <!-- Django Messages (Errors/Success) -->
        {% if messages %}
        <div class="messages-container" style="margin-bottom: 20px">
          {% for message in messages %}
          <div
            class="message-box show {% if message.tags == 'error' %}error{% else %}success{% endif %}"
          >
            <i
              class="{% if message.tags == 'error' %}fa-solid fa-circle-exclamation{% else %}fa-solid fa-check-circle{% endif %}"
            ></i>
            {{ message }}
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- STEP 1: CHECK EMAIL FORM -->
        {% if step == 1 %}
        <form method="POST">
          {% csrf_token %}
          <input type="hidden" name="action" value="check_email" />

          <div class="input-group">
            <label>Email Address</label>
            <div class="input-wrapper">
              <i class="fas fa-envelope input-icon"></i>
              <input
                type="email"
                name="email"
                placeholder="name@school.edu"
                required
              />
            </div>
          </div>
          <button type="submit" class="btn-primary">
            Confirm Email <i class="fas fa-paper-plane"></i>
          </button>
        </form>
        {% endif %}

        <!-- STEP 2: RESET PASSWORD FORM -->
        {% if step == 2 %}
        <form method="POST">
          {% csrf_token %}
          <input type="hidden" name="action" value="reset_password" />

          <div class="input-group">
            <label>New Password</label>
            <div class="input-wrapper">
              <i class="fas fa-lock input-icon"></i>
              <input
                type="password"
                id="new_password"
                name="password"
                placeholder="Enter new password"
                required
              />
              <i
                class="fa-solid fa-eye toggle-password"
                onclick="togglePassword('new_password', this)"
              ></i>
            </div>
            <p class="helper-text">
              Must be at least 8 chars, 1 uppercase, 1 number.
            </p>
          </div>

          <div class="input-group">
            <label>Confirm Password</label>
            <div class="input-wrapper">
              <i class="fas fa-lock input-icon"></i>
              <input
                type="password"
                id="confirm_password"
                name="confirm_password"
                placeholder="Confirm password"
                required
              />
              <i
                class="fa-solid fa-eye toggle-password"
                onclick="togglePassword('confirm_password', this)"
              ></i>
            </div>
          </div>

          <button type="submit" class="btn-primary">
            Reset Password <i class="fas fa-check"></i>
          </button>
        </form>
        {% endif %}
      </div>
    </div>

    <!-- UI Only Scripts (No Fetch/AJAX) -->
    <script>
      // Only handles the visual toggle of the password eye icon
      function togglePassword(id, icon) {
        const input = document.getElementById(id);
        if (input.type === "password") {
          input.type = "text";
          icon.classList.replace("fa-eye", "fa-eye-slash");
          icon.classList.add("active");
        } else {
          input.type = "password";
          icon.classList.replace("fa-eye-slash", "fa-eye");
          icon.classList.remove("active");
        }
      }
    </script>
  </body>
</html>
