{% extends "base.html" %}
{% load static %}

{% block title %}Profile - Edify{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profileCss.css' %}" />
{% endblock %}

{% block content %}
<div class="profile-page-container">
    
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Profile Settings</h1>
            <p class="page-subtitle">Manage your personal information and bio.</p>
        </div>
        <div class="status-badge">
            <span class="status-dot"></span> Active
        </div>
    </div>

    <div class="profile-grid">

        <!-- LEFT SIDEBAR: Avatar -->
        <div class="card">
            <div class="card-body avatar-section">
                
                <!-- AVATAR FORM -->
                <form method="POST" enctype="multipart/form-data" action="{% url 'profiled' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_avatar">

                    <!-- Avatar Wrapper -->
                    <div class="avatar-wrapper" onclick="document.getElementById('profile_image_input').click()">
                        {% if user.profile_picture %}
                            <img id="avatar-preview" src="{{ user.profile_picture }}" class="avatar-img">
                        {% else %}
                            <img id="avatar-preview" src="" class="avatar-img hidden">
                            <div id="avatar-placeholder" class="avatar-placeholder">
                                {{ user.first_name|slice:":1"|upper }}
                            </div>
                        {% endif %}
                        
                        <div class="camera-overlay">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>

                    <input type="file" id="profile_image_input" name="profile_image" accept="image/*" class="hidden" onchange="previewAndSubmit(this)">
                    <button type="submit" id="submit-avatar" class="hidden"></button>
                </form>

                <h2 class="user-info-name">{{ user.first_name }} {{ user.last_name }}</h2>
                <p class="user-info-handle">@{{ user.username }}</p>

                <div class="user-id-box">
                    <div class="user-id-label">User ID</div>
                    <div class="user-id-value">{{ user.id }}</div>
                </div>
            </div>
        </div>

        <!-- RIGHT CONTENT: Forms -->
        <div class="right-content">

            <!-- 1. Personal Details Form -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-user-pen"></i> Personal Details</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{% url 'profiled' %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_info">

                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">First Name</label>
                                <input type="text" name="first_name" value="{{ user.first_name }}" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name</label>
                                <input type="text" name="last_name" value="{{ user.last_name }}" class="form-input">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Username</label>
                                <div class="input-group">
                                    <span class="input-prefix">@</span>
                                    <input type="text" name="username" value="{{ user.username }}" class="form-input">
                                </div>
                            </div>
                            
                            <div class="form-group full-width">
                                <label class="form-label">Bio / About Me</label>
                                <textarea name="bio" rows="4" class="form-input" placeholder="Tell us a little about yourself...">{{ user.bio }}</textarea>
                            </div>

                            <div class="form-group full-width">
                                <label class="form-label">Email Address</label>
                                <input type="email" value="{{ user.email }}" readonly class="form-input disabled">
                                <p class="helper-text">Contact support to change email.</p>
                            </div>
                        </div>

                        <div class="btn-wrapper">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 2. Security Form -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-shield-alt"></i> Security</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{% url 'profiled' %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_password">

                        <div class="form-group">
                            <label class="form-label">Current Password</label>
                            <div class="password-wrapper">
                                <input type="password" name="old_password" id="old_password" required class="form-input password-field">
                                <i class="fas fa-eye toggle-password" onclick="togglePassword('old_password', this)"></i>
                            </div>
                        </div>
                        
                        <div class="divider"></div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">New Password</label>
                                <div class="password-wrapper">
                                    <input type="password" name="new_password" id="new_password" required class="form-input password-field">
                                    <i class="fas fa-eye toggle-password" onclick="togglePassword('new_password', this)"></i>
                                </div>
                                <!-- âœ… Added Requirements List -->
                                <ul class="password-requirements">
                                    <li>At least 6 characters</li>
                                    <li>One uppercase & lowercase letter</li>
                                    <li>One number (0-9)</li>
                                    <li>One special character (!@#$...)</li>
                                </ul>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm Password</label>
                                <div class="password-wrapper">
                                    <input type="password" name="confirm_password" id="confirm_password" required class="form-input password-field">
                                    <i class="fas fa-eye toggle-password" onclick="togglePassword('confirm_password', this)"></i>
                                </div>
                            </div>
                        </div>

                        <div class="btn-wrapper">
                            <button type="submit" class="btn btn-dark">Update Password</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- JS for UI Interactions -->
<script>
    // Avatar Auto-Submit
    function previewAndSubmit(input) {
        if (input.files && input.files[0]) {
            document.getElementById('submit-avatar').click();
        }
    }

    // Toggle Password Visibility
    function togglePassword(inputId, icon) {
        const input = document.getElementById(inputId);
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
        } else {
            input.type = "password";
            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");
        }
    }
</script>
{% endblock %}