{% extends 'base.html' %}
{% load static %}

{% block title %}Public Library - Edify{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/publicCss.css' %}">
{% endblock %}

{% block content %}
<div class="public-container">
  
  <!-- Header Section -->
  <div class="library-header">
    <div class="header-content">
      <h1 class="page-title">Public Library</h1>
      <p class="page-subtitle">Discover, learn, and share knowledge with the community.</p>
    </div>
  </div>

  <!-- Search Toolbar -->
  <div class="search-toolbar">
    <form method="get" action="{% url 'public' %}" class="toolbar-form">
        
        <div class="search-wrapper">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" name="q" value="{{ query }}" placeholder="Search for resources..." autocomplete="off"/>
        </div>

        <div class="filter-wrapper">
            <div class="select-box">
                <i class="fa-solid fa-filter filter-icon"></i>
                <select name="subject" onchange="this.form.submit()">
                    <option value="All" {% if selected_subject == 'All' %}selected{% endif %}>All Subjects</option>
                    {% for subj in subjects %}
                        <option value="{{ subj }}" {% if selected_subject == subj %}selected{% endif %}>{{ subj }}</option>
                    {% endfor %}
                </select>
                <i class="fa-solid fa-chevron-down arrow-icon"></i>
            </div>
            <button type="submit" class="btn-search">Search</button>
        </div>

    </form>
  </div>

  <!-- Results Grid -->
  {% if results %}
    <div class="resource-grid">
      {% for file in results %}
      <div class="resource-card">
        
        <!-- Card Header -->
        <div class="card-header-visual">
            <div class="file-type-badge">
                <i class="fa-solid fa-file-lines"></i> {{ file.file_type|upper }}
            </div>
            
            <!-- ✅ NEW: JS-Powered Like Button -->
            <button 
                type="button"
                class="btn-like {% if file.is_favorite %}active{% endif %}" 
                onclick="toggleHeart(this, '{{ file.id }}')"
                title="Like this resource"
            >
                <i class="{% if file.is_favorite %}fa-solid{% else %}fa-regular{% endif %} fa-heart"></i>
            </button>
        </div>

        <!-- Card Content -->
        <div class="card-body">
            <h3 class="resource-title" title="{{ file.title }}">{{ file.title }}</h3>
            
            <div class="badge-container">
                <span class="pill-badge subject">{{ file.subject }}</span>
                <span class="pill-badge grade">{{ file.grade }}</span>
            </div>

            <!-- Publisher Info -->
            <div class="publisher-info">
                <div class="avatar-circle {% if file.author_name == 'You' %}me{% endif %}">
                    <i class="fa-solid fa-user"></i>
                </div>
                <span class="publisher-name {% if file.author_name == 'You' %}me{% endif %}">
                    {{ file.author_name }}
                </span>
                <span class="separator">•</span>
                <span class="file-size">{{ file.file_size }}</span>
            </div>
        </div>

        <!-- Card Actions -->
        <div class="card-footer">
            <a href="{% url 'download_file' file.id %}" class="btn-download">
                Download <i class="fa-solid fa-cloud-arrow-down"></i>
            </a>
        </div>

      </div>
      {% endfor %}
    </div>

  {% else %}
    <!-- Empty State -->
    <div class="empty-container">
        <div class="empty-illustration">
            <i class="fa-solid fa-layer-group"></i>
        </div>
        <h3>No results found</h3>
        <p>We couldn't find any resources matching your search.</p>
        {% if query or selected_subject != 'All' %}
            <a href="{% url 'public' %}" class="btn-clear">Clear Filters</a>
        {% endif %}
    </div>
  {% endif %}

</div>

{% block extra_js %}
<script>
    // ✅ AJAX Toggle Heart Logic
    async function toggleHeart(btn, fileId) {
        const icon = btn.querySelector('i');
        const isFav = btn.classList.contains('active');
        
        // 1. Optimistic UI Update
        if (isFav) {
            btn.classList.remove('active');
            icon.classList.remove('fa-solid');
            icon.classList.add('fa-regular');
        } else {
            btn.classList.add('active');
            icon.classList.remove('fa-regular');
            icon.classList.add('fa-solid');
        }

        // 2. Send to Backend
        try {
            const response = await fetch(`/toggle_favorite/${fileId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            });
            // If error, you can revert the UI change here
        } catch (err) { console.error(err); }
    }
</script>
{% endblock %}
{% endblock %}